# AYTO Solver

"Are You The One" matching problem solver with FastAPI web API, multiple solver backends, and a static frontend.

## Architecture

```
ayto_solver/
  api/
    main.py              # FastAPI app (endpoints, CORS, static files)
    static/
      index.html         # Legacy Web UI
  models/
    schemas.py           # Pydantic request/response models
  solvers/
    mip_solver.py        # MIP solver (single solution, fast, AMD64 only)
    mip_multi_solver.py  # MIP solver (enumerates all solutions, probabilities)
    graph_solver.py      # Graph-based solver (networkx, all solutions, ARM-native)
  utils/
    __init__.py
tests/
  test_examples.py       # Smoke tests against real season data in examples/
  test_properties.py     # Hypothesis property-based tests
  test_synthetic.py      # Synthetic 3x3/4x4 test cases
examples/
  *.yaml                 # Real AYTO season data files (hand-edited)
seasons.json             # Season registry (hand-maintained metadata)
build.py                 # Runs graph solver, writes JSON to frontend/public/data/
deploy.sh                # build.py + npm build + rsync to VPS

frontend/                # Astro + Svelte + Tailwind static site
  astro.config.mjs
  package.json
  public/
    data/                # Generated by build.py (not hand-edited)
      seasons.json       #   Season index
      {slug}/latest.json #   Per-season solver results
  src/
    layouts/Base.astro
    pages/
      index.astro        # Homepage: hero + archive grid
      staffel/[slug].astro  # Season detail page
    components/
      Header.astro, Footer.astro, SeasonCard.astro
      MatchGrid.svelte, MatchCard.svelte, ConfirmedMatches.svelte
      CertaintyMeter.svelte, DoubleMatchInfo.svelte
    lib/
      types.ts           # TypeScript interfaces for JSON schemas
      i18n.ts            # DE/EN string maps
      helpers.ts         # Probability tiers, formatting
    styles/global.css    # Tailwind + custom theme
```

## Commands

**Always use the venv or Docker — never run bare-metal Python.**

### Docker (required on ARM Macs for MIP solver / tests)

```bash
docker compose build
docker compose up -d
docker compose exec api pytest tests/ -v
docker compose down
```

### Local (venv at `.venv/`)

```bash
.venv/bin/pip install -r requirements.txt
.venv/bin/python build.py       # Generate static JSON data (graph solver, ARM-native)
cd frontend && npm run build    # Build static site to frontend/dist/
cd frontend && npm run dev      # Dev server with hot reload
```

### Deploy

```bash
./deploy.sh   # build.py + npm build + rsync to VPS
```

## Platform Constraints

- **MIP solver**: Requires `python-mip` (AMD64 Linux only). Use Docker on ARM Macs.
- **Graph solver**: Pure Python + networkx. Works natively on ARM Mac. Used by `build.py`.
- The `solvers/__init__.py` lazily imports MIP solvers — graph solver works without `python-mip`.

## Frontend Workflow

1. Update season YAML data in `examples/` after each episode
2. Update `seasons.json` if needed (new season, episode count)
3. Run `build.py` to regenerate JSON data
4. Run `npm run build` in `frontend/` to build static site
5. Deploy with `deploy.sh` (rsync to VPS, nginx serves static files)

## API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/` | GET | Legacy Web UI |
| `/health` | GET | Health check (`{"status": "healthy"}`) |
| `/solve/mip` | POST | MIP solver (single solution; `?enumerate_solutions=true` for all) |
| `/solve/graph` | POST | Graph solver (all solutions + probabilities) |
| `/docs` | GET | Swagger UI |

## Solver Types

- **MIP** (`mip_solver.py`): Mixed Integer Programming via python-mip/CBC. Fast single solution. AMD64 only.
- **MIP Multi** (`mip_multi_solver.py`): Enumerates up to 1000 solutions, calculates match probabilities and double-match candidates.
- **Graph** (`graph_solver.py`): NetworkX-based bipartite matching. Enumerates all valid matchings, computes probabilities. ARM-native.

## Testing

Tests require AMD64 (for MIP solver). Run inside Docker on ARM Macs:

```bash
docker compose exec api pytest tests/ -v
```

`pytest.ini` is configured with `pythonpath = .` and `testpaths = tests`.
